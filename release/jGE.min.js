const π=Math.PI,π2=2*π,π_hf=.5*π;function RandomClamped(){let t=Math.floor(100*Math.random())%2,e=Math.random();return(1==t?-1:1)*e}function GetEventPosition(t){var e,s;if(-1!=t.type.indexOf("touch"))try{var i=t.changedTouches[0];s=Math.floor(i.pageY),e=Math.floor(i.pageX)}catch(e){console.error(t,e)}else t.offsetX||0==t.offsetX?(e=t.offsetX,s=t.offsetY):console.error("获取鼠标坐标失败！");return new Vector2D(e,s)}function LoadResources({method:t="POST",async:e=!0,data:s=null,type:i="json",url:n="",success:a=(t=>{}),error:h=(t=>{}),ontimeout:r=(t=>{}),onprogress:o=(t=>{}),onuprogress:l=(t=>{})}={}){let d=i;"image"==i||"video"==i?(t="GET",i="blob"):"config"==i?(t="GET",i="json"):(i="script")&&(t="GET",i="text");let c=new XMLHttpRequest;c.open(t,n,e),e&&(c.responseType=i),c.setRequestHeader("Content-type","application/x-www-four-urlencoded;charset=UTF-8"),c.onload=function(t){if(200==this.status||304==this.status){let t=this.response;if(e||"json"!=i){if("image"==d)(t=new Image).src=window.URL.createObjectURL(this.response),t.onload=(e=>window.URL.revokeObjectURL(t.src));else if("video"==d)(t=document.createElement("video")).src=window.URL.createObjectURL(this.response),t.onload=(e=>window.URL.revokeObjectURL(t.src));else if("script"==d){let e=document.createElement("script");e.textContent=t,document.body.appendChild(e)}}else t=JSON.parse(t);a.call(this,t)}},c.ontimeout=r,c.onerror=h,c.upload.onprogress=l,c.onprogress=function(t){o.call(this,t.total,t.loaded)};try{c.send(s)}catch(t){h.call(this,t)}}function GetURL({method:t="POST",async:e=!0,data:s=null,type:i="json",url:n="",ontimeout:a=(t=>{}),onprogress:h=(t=>{}),onuprogress:r=(t=>{})}){return new Promise((o,l)=>{let d,c=i;switch(i){case"image":case"video":d="blob",t="GET";break;case"config":d="json",t="GET";break;case"script":d="text",t="GET";break;default:d=i}let u=new XMLHttpRequest;u.open(t,n,e),e&&(u.responseType=d),u.setRequestHeader("Content-type","application/x-www-four-urlencoded;charset=UTF-8"),u.onload=function(t){if(404==this.status)return l(this);if(200==this.status||304==this.status){let t=this.response;if(e||"json"!=i){if("image"==c)(t=new Image).src=window.URL.createObjectURL(this.response),t.onload=(e=>window.URL.revokeObjectURL(t.src));else if("video"==c)(t=document.createElement("video")).src=window.URL.createObjectURL(this.response),t.onload=(e=>window.URL.revokeObjectURL(t.src));else if("script"==c){let e=document.createElement("script");e.textContent=t,document.body.appendChild(e)}}else t=JSON.parse(t);o(t)}},u.ontimeout=a,u.onerror=l,u.upload.onprogress=r,u.onprogress=(t=>h.call(this,t.total,t.loaded)),u.send(s)})}class Vector2D{constructor(...t){let e,s;1==t.length?({x:e=0,y:s=0}=t[0]):[e=0,s=0]=t,this.speed=0,this.va=0,this._x=0,this._y=0,this.x=e,this.y=s}get x(){return this._x}get y(){return this._y}set x(t){this._x=t,this.speed=this.Length(),this.va=Math.atan2(this.y,this.x)}set y(t){this._y=t,this.speed=this.Length(),this.va=Math.atan2(this.y,this.x)}Velocity(t,e){this._x=t*Math.cos(e),this._y=t*Math.sin(e),this.speed=t,this.va=e%π2}Copy(t){this.x=t.x,this.y=t.y}Cloen(){return new Vector2D(this)}Zero(){}isZero(){return 0===this.x&&0===this.y}Length(){return Math.sqrt(this.x*this.x+this.y*this.y)}LengthSq(){return this.x*this.x+this.y*this.y}Normalize(){var t=this.Length();return new Vector2D(this.x/t,this.y/t)}Dot(t){return this.x*t.x+this.y*t.y}Sign(t){}Perp(){}Truncate(t){}Distance(t){return Math.sqrt(this.DistanceSq(t))}DistanceSq(t){return Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2)}GetReverse(){}AddIn(t){this.x+=t.x,this.y+=t.y}MinusIn(t){this.x-=t.x,this.y-=t.y}MultiplyIn(t){this.x*=t,this.y*=t}Add(t){return new Vector2D(this.x+t.x,this.y+t.y)}Minus(t){return new Vector2D(this.x-t.x,this.y-t.y)}Multiply(t){return new Vector2D(this.x*t,this.y*t)}Turn(t){return new Vector2D(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}Equal(t){return this.x==t.x&&this.y==t.y}*[Symbol.iterator](){yield this.x,yield this.y}}class ShowObj extends Vector2D{constructor({x:t=0,y:e=0,angle:s=0}={}){super({x:t,y:e});let i=Symbol("ObjManager"),n=this.Objects={rObj:[],uObj:[],items:new WeakSet};this.isDel=!1,this.angle=s,this.visible=!0,this[i]={add:function(t){n.items.has(t)||(t.isDel=!1,n.items.add(t),n.uObj.push(t),void 0!=t.render&&(void 0==t.index&&(t.index=1),Array.isArray(n.rObj[t.index])||(n.rObj[t.index]=[]),n.rObj[t.index].push(t)))},del:function(t){n.items.has(t)&&(t.isDel=!0,n.items.delete(t))}},this.add=((...t)=>(this[i].add.bind(this)(...t),this)),this.del=this[i].del.bind(this)}update(t,e={x:0,y:0},s=0){this.visible&&(this.Objects.uObj.forEach((i,n)=>{i.isDel?this.Objects.uObj.splice(n,1):i.update(t,new Vector2D(this).Add(e),this.angle+s)}),this._updateHandler&&this._updateHandler(t,new Vector2D(this),this.angle),this.Objects.rObj.map(t=>{t.forEach((e,s)=>{e.isDel&&t.splice(s,1)})}))}render(t){this.visible&&this.Objects.rObj.map(e=>{for(let s of e)s.isDel||s.render(t)})}*[Symbol.iterator](){for(let t=0;t<this.Objects.uObj.length;t++)yield this.Objects.uObj[t]}set updateHandler(t){t&&(this._updateHandler=t.bind(this))}}class $$tk_base{constructor({styleType:t=null,style:e=null,pos:s=new Vector2D,update:i=null}={}){this.fillStyle=null,this.strokeStyle=null,this.isAutoEnd=!1,this.angle=0,this.parentAngle=0,this.styleType=t,this.setStyle(e),this.pos=new Vector2D(...s),this.centerPoint=new Vector2D,this.updateHandler=i,this.isDel=!1}update(t,e,s){this._updateHandler&&this._updateHandler(t,e,s),this.parentAngle=s}render(t){}setStyle(t){let e="",s="";switch(this.styleType){case"fill":this.fillStyle=t;break;case"stroke":e=t;break;case"both":({fillStyle:s,strokeStylest:e}=t)}if(e){let[t,i=1,n="bull",a="miter"]=e.split(" ");this.strokeStyle=t,this.lineWidth=i,this.lineCap=n,this.lineJoin=a,this.fillStyle=s}}__draw(t,e,s){t.save(),e&&e(t),this.fillStyle&&(t.fillStyle=this.fillStyle,t.fill()),this.strokeStyle&&(t.strokeStyle=this.strokeStyle,t.lineWidth=1*this.lineWidth,t.lineCap=this.lineCap,t.lineJoin=this.lineJoin,this.isAutoEnd&&t.closePath(),t.stroke()),s&&s(t),t.restore()}set updateHandler(t){t&&(this._updateHandler=t.bind(this))}}class $tk_path extends $$tk_base{constructor({styleType:t="stroke",style:e="white",points:s=null,pos:i=[0,0],update:n=null}={}){if(!s||s.length<=0)return null;super({styleType:t,style:e,pos:i,update:n}),this.points=[];let a=null;this.isAutoEnd=-1==s[s.length-1]&&(a=s.pop(),!0),s.forEach(t=>{this.points.push(Array.isArray(t)?new Vector2D(t[0],t[1]):t)}),a&&s.push(a),this.setting={styleType:t,style:e,points:s,pos:i,update:n}}update(t,e,s){this.centerPoint=e.Add(this.pos.Turn(s)),super.update(t,e,s)}render(t){0==this.points.length||this.isDel||this.__draw(t,()=>this.toPath(t),!1)}toPath(t){t.beginPath(),t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),t.moveTo(this.points[0].x,this.points[0].y);for(let e of this.points)t.lineTo(e.x,e.y)}clone(){return new $tk_path(this.setting)}}class $tk_ellipse extends $$tk_base{constructor({styleType:t="stroke",style:e="white 1",points:s=null,pos:i=[0,0],update:n=null,a:a=0,b:h=0,r:r=0}={}){super({styleType:t,style:e,pos:i}),0!=r&&(a=r,h=r),this.a=a,this.b=h,this.r=Math.max(a,h),this.ratioX=a/this.r,this.ratioY=h/this.r,this.isAutoEnd=!0}update(t,e,s){this.centerPoint=e.Add(this.pos.Turn(s)),super.update(t,e,s)}render(t){this.__draw(t,()=>this.toPath(t),!1)}toPath(t){t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),this.a!=this.b&&t.scale(this.ratioX,this.ratioY),t.beginPath(),t.arc(this.pos.x/this.ratioX,this.pos.y/this.ratioY,this.r,0,2*π,!1)}}class $tk_arc extends $$tk_base{constructor(){super({styleType:styleType,style:style,pos:pos})}}class $tk_sprite{constructor({img:t={},pos:e=[0,0],area:s={width:t.width,height:t.height},sarea:i=null,update:n=null}={}){if(null==t)return null;this.img=t,this.barea=Object.freeze({width:s.width,height:s.height}),this.area=s,this.sarea=i,this.pos=new Vector2D(...e),this.dPos=new Vector2D,this.centerPoint=new Vector2D,this.updateHandler=n,this.angle=0,this.parentAngle=0,this.isDel=!1}update(t,e,s){this.centerPoint=e.Add(this.pos.Turn(s)),this.dPos.Copy(this.centerPoint),this.dPos.x-=this.area.width/2,this.dPos.y-=this.area.height/2,this.parentAngle=s,this._updateHandler&&this._updateHandler(t,e,s)}render(t){t.save(),t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),this.sarea?t.drawImage(this.img,this.sarea.x,this.sarea.y,this.sarea.width,this.sarea.height,-this.area.width/2,-this.area.height/2,this.area.width,this.area.height):this.area&&t.drawImage(this.img,-this.area.width/2,-this.area.height/2,this.area.width,this.area.height),t.restore()}set updateHandler(t){t&&(this._updateHandler=t.bind(this))}scale(t){this.area.width=this.barea.width*t,this.area.height=this.barea.height*t}}class $tk_font extends $$tk_base{constructor({text:t="Text Unset",styleType:e="fill",style:s="white",font:i="22px 微软雅黑",angle:n=0,pos:a=[0,0],update:h=null}){super({styleType:e,style:s,pos:a,update:h}),this.font=i,this.angle=n,this.text=t}update(t,e,s){this.centerPoint=e.Add(this.pos.Turn(s)),super.update(t,e,s)}render(t){t.beginPath(),this.__draw(t,!1,()=>{t.font=this.font,t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),t.textAlign="center",t.textBaseline="middle",this.fillStyle&&t.fillText(this.text,0,0),this.strokeStyle&&t.strokeText(this.text,0,0)})}text(t){this.text=t}}class $tk_video extends $tk_sprite{constructor(t){t.img=t.video,super(t),this.video=this.img,this.area.width=this.area.width||this.video.videoWidth,this.area.height=this.area.height||this.video.videoHeight;let e=this.area;this.barea=Object.freeze({width:e.width,height:e.height})}update(t,e,s){super.update(t,e,s),0==this.area.width&&(this.area.width=this.video.videoWidth),0==this.area.height&&(this.area.height=this.video.videoHeight)}pause(t){return!1===t?this.video.play():this.video.paused?this.video.play():this.video.pause()}loop(t){this.video.loop=t}silent(t){this.video.volume=t?1:0}}class $tk_animation extends $tk_sprite{constructor({img:t=null,pos:e=[0,0],area:s={x:0,y:0,width:t.width,height:t.height},sarea:i=null,fps:n=8,frame:a=null,farea:h={width:0,height:0},update:r=null}={}){if(!a||h.height<=0||h.width<=0)return console.warn(`动画配置，帧数设置错误，详情请参看配置：${JSON.stringify([...arguments])}\n            入参说明：area是当前图片的可视区，当多组sprite在同一个图片时，用于限定当前组的范围。若省略则用全图大小作范围。\n            sarea 是最终输出时的裁切区。若省略则输出结果不裁切。 【暂未实现】\n            farea 是帧长宽配置，本方法要求动画组的图片每帧尺寸一样。不可省略。\n            `),null;let o=[],{x:l,y:d}=s;for(let t=0;t<a;t++)o.push({x:l,y:d}),(l+=h.width)>=s.width&&(0,l=s.x,d+=h.height);super({img:t,pos:e,area:h,sarea:{x:o[0].x,y:o[0].y,width:h.width,height:h.height},update:r}),this.fps=Number(n),this.frame=a,this.curFrame=0,this.playTime=0,this.frames=o,this.timeSpan=1e3/this.fps,console.dir(this)}update(t,e,s){this.playTime+=t,this.playTime>=this.timeSpan&&(this.curFrame++,this.curFrame>=this.frame&&(this.curFrame=0),this.sarea.x=this.frames[this.curFrame].x,this.sarea.y=this.frames[this.curFrame].y,this.playTime%=this.timeSpan),super.update(t,e,s),this.parentAngle=s}}class jGE extends ShowObj{SetConfig(t){this.setting=t,this.run.width=this.setting.width,this.run.height=this.setting.height,this.run.bgColor="black",this.run.status="run"}Init(t){this.add(new EventManager(this)),this.add(new SceneManager(this)),this.add(this.ResourceManager=new ResourceManager(this)),this.add(new ObjectFactory(this));const e=this.run,s=this.setting;if(void 0!=t&&this.SetConfig(t),s.dom=document.createElement("canvas"),!s.dom.getContext)return null;s.dom.id=s.id,s.dom.width=s.width,s.dom.height=s.height,this.keyboards=new Set,this.__bind_helper(document.body,["keypress","keydown","keyup"],t=>{this.keyboards.forEach(e=>{e.keyHandle(t)})}),this.__bind_helper(s.dom,["click","touchstart"in s.dom?"touchstart":"mousedown","touchmove"in s.dom?"touchmove":"mousemove","touchend"in s.dom?"touchend":"mouseup"],t=>{e.curMousePoint=GetEventPosition(t),this.keyboards.forEach(s=>{s.pointHandle(t,e.curMousePoint)})}),e.context2D=s.dom.getContext("2d"),e.curMousePoint=new Vector2D,e.rendertime=0,e.curfram=0,e.aFps=0,e.vFps=0,e.fps_rc_time=0,this.update(16),this.render()}update(t){const e=this;0==t&&console.log(0);const s=this.run;"run"==s.status&&(s.timemark=new Date,this.managers.forEach(e=>e.update(t)),this.Objects.uObj.forEach((s,i)=>{s.isDel?this.Objects.uObj.splice(i,1):s.update(t,e)}),this.Objects.rObj.map(t=>{t.forEach((e,s)=>{e.isDel&&t.splice(s,1)})}),requestAnimationFrame(function(){let t=new Date-s.timemark;s.fps=Math.round(1e5*(s.rendertime-s.curfram)/t)/100,s.curfram=s.rendertime,s.aFps+=s.fps,s.fps_rc_time++,e.update(t)}))}render(){const t=this.run;if("run"!=t.status)return;t.context2D.clearRect(0,0,t.width,t.height),t.context2D.fillStyle=t.bgColor,t.context2D.fillRect(0,0,t.width,t.height),this.Objects.rObj.map(e=>{for(let s of e)s.isDel||s.render(t.context2D)}),t.rendertime++;const e=this;requestAnimationFrame(function(){e.render()})}_add(t){switch(t.Role){case"Manager":this.managers.add(t);break;case"Keyboard":this.super_add(t.VirtualKeyboard),this.keyboards.add(t);break;default:this.super_add(t)}}clean(){this.Objects.rObj=[],this.Objects.uObj=[]}GetDom(){return this.setting.dom}Pause(){this.run.status="run"==this.run.status?"pause":"run","run"==this.run.status&&(this.update(16),this.render())}GetArea(){return{width:this.setting.dom.width,height:this.setting.dom.height}}GetSetting(){return this.setting}IsInIt(t,e){const s=this.run.context2D;s.save(),e.toPath(s),s.closePath();let i=s.isPointInPath(t.x,t.y);return s.restore(),i}OnMouse(t,e,s){this.setting.dom.addEventListener(t,s?e.bind(s):e)}set backgroundColor(t){this.run.bgColor=t}__bind_helper(t,e,s){e.forEach(e=>t.addEventListener(e,s))}constructor(){super(),this.version=[3,3,0],this.setting={};this.run={};this.temp={},this.managers=new Set,this.super_add=this.add,this.add=this._add;let t={};arguments.length>0&&typeof arguments[0]==typeof{}&&(t=arguments[0]);var e=new GetConfig;for(let s in t)e[s]=t[s];this.SetConfig(e),this.on=(()=>{}),this.one=(()=>{}),this.broadcast=(()=>{}),this.get=(()=>{}),this.Init()}}class Manager{constructor(t,e="默认管理器"){this._jGE=t,t.run.iDBug&&console.log(`[%c报告%c] ${e}已启动。🐠🐠🐠🐠🐠。`,"color:green","color:black"),this.Role="Manager"}update(t){}}class EventManager extends Manager{constructor(t){super(t,"事件管理器"),this.eventQueue=new Map,this.eventOne=new Map,this.curEventSet=new Set,this.curEventObj=new Map,this._jGE=t,t.on=this.on.bind(this),t.one=this.one.bind(this),t.broadcast=this.broadcast.bind(this)}on(t,e){let s=this.eventQueue.get(t);s||this.eventQueue.set(t,s=[]),s.push(e)}one(t,e){let s=this.eventOne.get(t);s||this.eventOne.set(t,s=[]),s.push(e)}off(t){this.eventQueue.set(t,[])}broadcast(t,e){this.curEventSet.add(t),this.curEventObj.set(t,e)}update(t){let e=new Function;for(let t of this.eventQueue.keys())if(this.curEventSet.has(t)){let s=this.eventQueue.get(t),i=this.curEventObj.get(t);s.forEach(s=>{s(i),e(t,s)})}for(let t of this.eventOne.keys())if(this.curEventSet.has(t)){let s=this.eventOne.get(t),i=this.curEventObj.get(t);s.forEach(s=>{s(i),e(t,s)}),this.eventOne.delete(t)}this.curEventSet.clear(),this.curEventObj.clear()}}class ObjectFactory extends Manager{constructor(t){super(t,"对象工厂"),this.objectCfg=new Map,this.objectHub=new Map,t.one("jGE.Config.Loaded.object",t=>{let e=new Map([["path",$tk_path],["sprite",$tk_sprite],["text",$tk_font],["video",$tk_video],["anima",$tk_animation]]);t.forEach(t=>{t.setting.forEach(t=>{this.objectCfg.has(t.type)?console.error(`对象配置文件出错，对象类型[${t.type}]发现重复。\n配置:${JSON.stringify(t)}`):(t.pos||(t.pos=[0,0]),this.__init_cfg(t,e),this.objectCfg.set(t.type,t))})})}),t.one("jGE.Resource.Loaded",e=>{this.objectCfg.forEach(e=>e.items.forEach(e=>{"video"==e.type?e.video=t.get(e.res):/^(?:sprite|anima)$/.test(e.type)&&(e.img=t.get(e.res))}))})}__init_cfg(t,e){t.items?t.items.forEach(s=>{if(s.handler=e.get(s.type),!s.handler)return void console.error(`对象配置文件出错：可视部件类型错误${s.type}。\n配置：${JSON.stringify(t)}`);let i={};for(let t in s)if("function"!=typeof s[t])switch(t){case"points":i[t]=[],s[t].forEach(e=>i[t].push(new Vector2D(...e)));break;default:i[t]=s[t]}s.setting=i}):console.error(`对象配置文件出错：items节点缺失。\n配置：${JSON.stringify(t)}`)}create(t){let e=/^@([^@&#].*?)&([^@&#].*?)#([^@&#].*)$/gi.test(t),[s,i,n]=[RegExp.$1,RegExp.$2,RegExp.$3];if(!e){if(!/^@([^@&#].*?)&([^@&#].*)/.test(t))return console.error(`创建对象失败，对象类型配置出错${t}`),null;[s,i]=[RegExp.$1,RegExp.$2],n=i.substr(0,2)+(1e5*Math.random()).toFixed(0)}let a=this.objectCfg.get(i);if(!a||!a.items)return console.error(`创建对象失败，没找到该类配置：${i}；或缺失items字段。`),null;let h=new ShowObj(...a.pos);return a.items.forEach(t=>h.ObjManager.add(new t.handler(t.setting))),this.objectHub.set(`@${s}&${i}#${n}`,h),h}get(t){let e=this.objectHub.get(t);return e||this.create(t)}del(t){}update(t,e){}}class ResourceManager extends Manager{constructor(t){super(t,"资源管理"),this.package=new Map,this.processing=new Map,this.packprocessing=Symbol(),this.Init(),this.isLoading=!1}Init(){}GetRes(t,e=""){let s=void 0;try{s=this.package.get(e).get(t)}catch(i){console.warn(`尝试获取资源失败(${e}-${t})，资源尚未加载。信息：${i}`),s=null}return s}LoadResPackage(t="",e=[]){this.package.has(t)||(this.package.set(t,new Map),this.package.get(t).set(this.packprocessing,0),this.processing.set(t,new Map)),e.forEach(e=>{this.LoadRes(t,e)}),this.isLoading=!0}LoadRes(t="default",{type:e="image",url:s="",id:i=""}={}){let n=this.package.get(t),a=this.processing.get(t);this.package.has(t)&&n.has(i)?console.warn(`发现重复加载资源：${t}\\${i} 操作已停止。`):this.Ajax({url:s,dataType:e,onprogress:(t,e)=>{t=t<e?e:t,a.set(i,{l:e,t:t})}}).then(t=>{t.id=i,n.set(i,t)}).catch(t=>{console.error("AjaxEror:",t)})}UnLoadResPackage(t){if(!this.package.has(t))return!1;var e=this.package.get(t);return e.forEach(t=>{null}),this.package.delete(t)}GetPkProcessing(t){this.package.get(t);let e=this.processing.get(t);if(1==e.get(this.packprocessing))return 1;let[s,i]=[0,0];e.forEach(t=>{s+=t.l,i+=t.t});let n=Math.ceil(1e3*s/i)/1e3;return e.set(this.packprocessing,n),1==n&&this._jGE.broadcast("jGE.Resource.Package.Finish",t),n}GetProcessing(){return this.processing.get(this.packprocessing)}UpdateProcessing(t=!0){let e=new Map;for(let t of this.package.keys())e.set(t,this.GetPkProcessing(t));if(t){let[t,s]=[0,0];for(let i of e.values())t+=i,s++;let i=t/s;return this.processing.set(this.packprocessing,i),i}return e}update(t,e){if(this.isLoading){let t=this.UpdateProcessing();Math.abs(t-1)<Number.EPSILON*Math.pow(2,2)&&(this.isLoading=!1),console.log(t),this.isLoading||this._jGE.broadcast("jGE.Resource.Finish")}}Ajax({method:t="POST",url:e="",data:s="",async:i=!0,ontimeout:n=12e3,responseType:a="text",dataType:h="json",onprogress:r=(()=>{})}={}){return new Promise(function(o,l){let d=new XMLHttpRequest;d.open(t,e,i),"image"!=h&&"video"!=h||(a="blob","image"==h&&(h="img")),i&&(d.responseType=a),d.setRequestHeader("Content-type","application/x-www-four-urlencoded;charset=UTF-8"),d.ontimeout=n,d.onload=function(t){if(200==this.status||304==this.status){let t=null;i||"json"!=h?(t=document.createElement(h),"script"==h?(t.textContent=this.response,document.body.appendChild(t)):(t.src=window.URL.createObjectURL(this.response),t.onload=(e=>window.URL.revokeObjectURL(t.src)))):t=JSON.parse(this.response),o.call(this,t)}},d.onerror=l,d.onprogress=function(t){r.call(this,t.total,t.loaded)};try{d.send(s)}catch(t){l.call(this,t)}})}}class SceneManager extends Manager{constructor(t){super(t,"场景调度管理"),t.one("jGE.Config.Loaded.scene",this.InitScene.bind(this)),t.one("jGE.Config.Loaded",this.PlayScene.bind(this)),this.sceneCfg=new Map,this.nextScene="",this.Logo()}InitScene(t){t.forEach(t=>{})}PlayScene(){}Logo(){let t=function(){this.angle=0};console.log("开始Logo展示 🐉 jGE");let e="180px '微软雅黑'",s=new Vector2D(this._jGE.run.width/2,this._jGE.run.height/2),i=new ShowObj(s.Add({x:180,y:-20}));i.add(new $tk_font({text:"jGE",styleType:"fill",style:"#555555",font:e,pos:[4,4]})),i.add(new $tk_font({text:"jGE",styleType:"fill",style:"#808080",font:e,pos:[3,3]})),i.add(new $tk_font({text:"jGE",styleType:"fill",style:"#aaaaaa",font:e,pos:[2,2]})),i.add(new $tk_font({text:"jGE",styleType:"fill",style:"white",font:e,pos:[0,0]}));let n=new ShowObj(s.Add({x:-180,y:0}));n.add(new $tk_font({text:"🐉",styleType:"fill",style:"rgba(255,0,0,0.82)",font:"200px serif",pos:[0,-10],update:t})),n.add(new $tk_font({text:"🐉",styleType:"stroke",style:"rgba(255,255,255,0.8) 5",font:"200px serif",pos:[0,-10],update:t})),n.add(new $tk_path({styleType:"stroke",style:"#808080 20 round round",points:[[-130,-130],[130,-130],[130,130],[-130,130],-1],pos:[2,2],update:t})),n.add(new $tk_path({styleType:"stroke",style:"rgba(255,255,255,0.9) 20 round round",points:[[-130,-130],[130,-130],[130,130],[-130,130],-1],pos:[0,0],update:t}));{let t=!1,e=this._jGE,s=function(s){void 0==this.showtime&&(this.showtime=0),this.showtime+=s,this.showtime>=1500&&(this.isDel=!0,t||(t=!0,e.broadcast("jGE.Scene.Logo.End")))};i.updateHandler=s,n.updateHandler=s}this._jGE.add(i),this._jGE.add(n)}}class Keyboard extends Manager{constructor(t){super(t,"虚拟键盘"),this.Role="Keyboard",this.isEnable=!0,this.allkey=new Map,this._virtualkeyboard=new ShowObj;const e=this._virtualkeyboard.AddIn.bind(this._virtualkeyboard),s=this._virtualkeyboard.Copy.bind(this._virtualkeyboard);this._virtualkeyboard.AddIn=((...t)=>{e(...t),this.flash()}),this._virtualkeyboard.Copy=((...t)=>{s(...t),this.flash()})}keyHandle(t){this.isEnable&&this.allkey.has(t.code)&&this.allkey.get(t.code).on(t)}pointHandle(t,e){if(!this.isEnable)return;let s={x:e.x,y:e.y,style:"point"};switch(t.type){case"mousemove":s.type="over";break;case"mousedown":s.type="keydown";break;case"mouseup":s.type="keyup";break;case"click":s.type="keypress";break;case"dblclick":s.type="dblclick";break;case"touchstart":s.type="keydown";break;case"touchmove":s.type="over";break;case"touchend":s.type="keyup"}this.allkey.forEach(t=>t.on(s))}turnOn(){this.isEnable=!0}turnOff(){this.isEnable=!1}add(t){t._jGE=this._jGE,this.allkey.set(t.code,t),this.VirtualKeyboard.add(t)}get(t){return this.allkey.get(t)}get VirtualKeyboard(){return this._virtualkeyboard}flash(){this.allkey.forEach(t=>t.flash()),this.VirtualKeyboard.update(0,this._jGE),this.allkey.forEach(t=>t.reset())}}class Key extends ShowObj{constructor({key:t="",code:e="",handler:s=null,upObjs:i=[],downObjs:n=[],hoverObj:a=[],actObj:h=null,x:r=0,y:o=0,angle:l=0}={}){super({x:r,y:o,angle:l}),this.handler=new Map,this.code=e,this.KEYSTATUS={Normal:Symbol(),Down:Symbol(),Hover:Symbol()},this.status=this.KEYSTATUS.Down,this.btShowObjs=new Map([[this.KEYSTATUS.Normal,i],[this.KEYSTATUS.Down,n],[this.KEYSTATUS.Hover,a]]),this.activeArea=h||i[0],this._jGE=null,null!==s&&addEventListener(type,s),this._changeStatus("keyup")}on(t){if("point"==t.style){if(!this._IsHit(t)){if(this.status!=this.KEYSTATUS.Hover)return;t.type="out"}t.code=this.code}if(this._changeStatus(t.type,t.style),!this.handler.has(t.type))return!1;this.handler.get(t.type).forEach(e=>{e(t)})}addEventListener(t,e){this.handler.has(t)||this.handler.set(t,new Set),this.handler.get(t).add(e)}removeEventListener(t){this.handler.has(t)&&this.handler.get(t).clear()}_changeStatus(t,e){if("keypress"==t)return;let s=this.status;switch(t){case"keydown":this.status=this.KEYSTATUS.Down;break;case"keyup":this.status="point"==e?this.KEYSTATUS.Hover:this.KEYSTATUS.Normal;break;case"over":this.status=this.KEYSTATUS.Hover;break;case"out":this.status=this.KEYSTATUS.Normal}s!=this.status&&(this.btShowObjs.get(s).forEach(t=>{this.del(t)}),this.btShowObjs.get(this.status).forEach(t=>{this.add(t)}))}flash(){this.btShowObjs.forEach(t=>t.forEach(t=>this.add(t)))}reset(){this.btShowObjs.forEach((t,e)=>{e!=this.status&&t.forEach(t=>this.del(t))})}_IsHit(t){return this._jGE.IsInIt(t,this.activeArea)}}function GetConfig(){return{id:"jGE_"+100*Math.random(),dom:null,width:700,height:750,fps:30,isRoundWorld:!0,keyHandler:function(t){}}}