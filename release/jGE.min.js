"use strict";function RandomClamped(){let e=Math.floor(100*Math.random())%2,t=Math.random();return(1==e?-1:1)*t}function GetEventPosition(e){var t,o;if(-1!=e.type.indexOf("touch"))try{var s=e.changedTouches[0];o=s.pageY,t=s.pageX}catch(t){console.error(e,t)}else e.offsetX||0==e.offsetX?(t=e.offsetX,o=e.offsetY):console.error("获取鼠标坐标失败！");return new Vector2D(t,o)}function LoadResources({method:e="POST",async:t=!0,data:o=null,type:s="json",url:n="",success:r=(e=>{}),error:a=(e=>{}),ontimeout:c=(e=>{}),onprogress:i=(e=>{}),onuprogress:l=(e=>{})}){let d=s;"image"==s||"video"==s?(e="GET",s="blob"):"config"==s?(e="GET",s="json"):(s="script")&&(e="GET",s="text");let p=new XMLHttpRequest;p.open(e,n,t),t&&(p.responseType=s),p.setRequestHeader("Content-type","application/x-www-four-urlencoded;charset=UTF-8"),p.onload=function(e){if(200==this.status||304==this.status){let e=this.response;if(t||"json"!=s){if("image"==d)(e=new Image).src=window.URL.createObjectURL(this.response),e.onload=(t=>window.URL.revokeObjectURL(e.src));else if("video"==d)(e=document.createElement("video")).src=window.URL.createObjectURL(this.response),e.onload=(t=>window.URL.revokeObjectURL(e.src));else if("script"==d){let t=document.createElement("script");t.textContent=e,document.body.appendChild(t)}}else e=JSON.parse(e);r.call(this,e)}},p.ontimeout=c,p.onerror=a,p.upload.onprogress=l,p.onprogress=function(e){i.call(this,e.total,e.loaded)};try{p.send(o)}catch(e){a.call(this,e)}}function GetURL({method:e="POST",async:t=!0,data:o=null,type:s="json",url:n="",ontimeout:r=(e=>{}),onprogress:a=(e=>{}),onuprogress:c=(e=>{})}){return new Promise((i,l)=>{let d,p=s;switch(s){case"image":case"video":d="blob",e="GET";break;case"config":d="json",e="GET";break;case"script":d="text",e="GET";break;default:d=s}let u=new XMLHttpRequest;u.open(e,n,t),t&&(u.responseType=d),u.setRequestHeader("Content-type","application/x-www-four-urlencoded;charset=UTF-8"),u.onload=function(e){if(404==this.status)return l(this);if(200==this.status||304==this.status){let e=this.response;if(t||"json"!=s){if("image"==p)(e=new Image).src=window.URL.createObjectURL(this.response),e.onload=(t=>window.URL.revokeObjectURL(e.src));else if("video"==p)(e=document.createElement("video")).src=window.URL.createObjectURL(this.response),e.onload=(t=>window.URL.revokeObjectURL(e.src));else if("script"==p){let t=document.createElement("script");t.textContent=e,document.body.appendChild(t)}}else e=JSON.parse(e);i(e)}},u.ontimeout=r,u.onerror=l,u.upload.onprogress=c,u.onprogress=(e=>a.call(this,e.total,e.loaded)),u.send(o)})}const π=Math.PI,π2=2*π,π_hf=.5*π;
class Vector2D{constructor(...t){let s,i;1==t.length?({x:s=0,y:i=0}=t[0]):[s=0,i=0]=t,this.x=s,this.y=i}Copy(t){this.x=t.x,this.y=t.y}Cloen(){return new Vector2D(this)}Zero(){}isZero(){return 0===this.x&&0===this.y}Length(){return Math.sqrt(this.x*this.x+this.y*this.y)}LengthSq(){return this.x*this.x+this.y*this.y}Normalize(){var t=this.Length();return new Vector2D(this.x/t,this.y/t)}Dot(t){return this.x*t.x+this.y*t.y}Sign(t){}Perp(){}Truncate(t){}Distance(t){return Math.sqrt(this.DistanceSq(t))}DistanceSq(t){}GetReverse(){}AddIn(t){this.x+=t.x,this.y+=t.y}MinusIn(t){this.x-=t.x,this.y-=t.y}MultiplyIn(t){this.x*=t,this.y*=t}Add(t){return new Vector2D(this.x+t.x,this.y+t.y)}Minus(t){return new Vector2D(this.x-t.x,this.y-t.y)}Multiply(t){return new Vector2D(this.x*t,this.y*t)}Turn(t){return new Vector2D(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}Equal(t){return this.x==t.x&&this.y==t.y}*[Symbol.iterator](){yield this.x,yield this.y}}
class ShowObj extends Vector2D{constructor({x:t=0,y:e=0,angle:i=0}={}){super({x:t,y:e});let s=Symbol("ObjManager"),h=this.Objects={rObj:[],uObj:[],items:new WeakSet};this.isDel=!1,this.angle=i,this.visible=!0,this[s]={add:function(t){h.items.has(t)||(t.isDel=!1,h.items.add(t),h.uObj.push(t),void 0!=t.render&&(void 0==t.index&&(t.index=1),Array.isArray(h.rObj[t.index])||(h.rObj[t.index]=[]),h.rObj[t.index].push(t)))},del:function(t){h.items.has(t)&&(t.isDel=!0,h.items.delete(t))}},this.add=((...t)=>(this[s].add.bind(this)(...t),this)),this.del=this[s].del.bind(this)}update(t,e={x:0,y:0},i=0){this.visible&&(this.Objects.uObj.forEach((s,h)=>{s.isDel?this.Objects.uObj.splice(h,1):s.update(t,new Vector2D(this).Add(e),this.angle+i)}),this._updateHandler&&this._updateHandler(t,new Vector2D(this),this.angle),this.Objects.rObj.map(t=>{t.forEach((e,i)=>{e.isDel&&t.splice(i,1)})}))}render(t){this.visible&&this.Objects.rObj.map(e=>{for(let i of e)i.isDel||i.render(t)})}*[Symbol.iterator](){for(let t=0;t<this.Objects.uObj.length;t++)yield this.Objects.uObj[t]}set updateHandler(t){t&&(this._updateHandler=t.bind(this))}}class $$tk_base{constructor({styleType:t=null,style:e=null,pos:i=new Vector2D,update:s=null}={}){this.fillStyle=null,this.strokeStyle=null,this.isAutoEnd=!1,this.angle=0,this.parentAngle=0,this.styleType=t,this.setStyle(e),this.pos=new Vector2D(...i),this.centerPoint=new Vector2D,this.updateHandler=s,this.isDel=!1}update(t,e,i){this._updateHandler&&this._updateHandler(t,e,i),this.parentAngle=i}render(t){}setStyle(t){let e="",i="";switch(this.styleType){case"fill":this.fillStyle=t;break;case"stroke":e=t;break;case"both":({fillStyle:i,strokeStylest:e}=t)}if(e){let[t,s=1,h="bull",a="miter"]=e.split(" ");this.strokeStyle=t,this.lineWidth=s,this.lineCap=h,this.lineJoin=a,this.fillStyle=i}}__draw(t,e,i){t.save(),e&&e(t),this.fillStyle&&(t.fillStyle=this.fillStyle,t.fill()),this.strokeStyle&&(t.strokeStyle=this.strokeStyle,t.lineWidth=1*this.lineWidth,t.lineCap=this.lineCap,t.lineJoin=this.lineJoin,this.isAutoEnd&&t.closePath(),t.stroke()),i&&i(t),t.restore()}set updateHandler(t){t&&(this._updateHandler=t.bind(this))}}class $tk_path extends $$tk_base{constructor({styleType:t="stroke",style:e="white",points:i=null,pos:s=[0,0],update:h=null}={}){if(!i||i.length<=0)return null;super({styleType:t,style:e,pos:s,update:h}),this.points=[];let a=null;this.isAutoEnd=-1==i[i.length-1]&&(a=i.pop(),!0),i.forEach(t=>{this.points.push(Array.isArray(t)?new Vector2D(t[0],t[1]):t)}),a&&i.push(a),this.setting={styleType:t,style:e,points:i,pos:s,update:h}}update(t,e,i){this.centerPoint=e.Add(this.pos.Turn(i)),super.update(t,e,i)}render(t){0==this.points.length||this.isDel||this.__draw(t,()=>this.toPath(t),!1)}toPath(t){t.beginPath(),t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),t.moveTo(this.points[0].x,this.points[0].y);for(let e of this.points)t.lineTo(e.x,e.y)}clone(){return new $tk_path(this.setting)}}class $tk_ellipse extends $$tk_base{constructor({styleType:t="stroke",style:e="white 1",points:i=null,pos:s=[0,0],update:h=null,a:a=0,b:r=0,r:l=0}={}){super({styleType:t,style:e,pos:s}),0!=l&&(a=l,r=l),this.a=a,this.b=r,this.r=Math.max(a,r),this.ratioX=a/this.r,this.ratioY=r/this.r,this.isAutoEnd=!0}update(t,e,i){this.centerPoint=e.Add(this.pos.Turn(i)),super.update(t,e,i)}render(t){this.__draw(t,()=>this.toPath(t),!1)}toPath(t){t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),this.a!=this.b&&t.scale(this.ratioX,this.ratioY),t.beginPath(),t.arc(this.pos.x/this.ratioX,this.pos.y/this.ratioY,this.r,0,2*π,!1)}}class $tk_arc extends $$tk_base{constructor(){super({styleType:styleType,style:style,pos:pos})}}class $tk_sprite{constructor({img:t={},pos:e=[0,0],area:i={width:t.width,height:t.height},sarea:s=null,update:h=null}={}){if(null==t)return null;this.img=t,this.barea=Object.freeze({width:i.width,height:i.height}),this.area=i,this.sarea=s,this.pos=new Vector2D(...e),this.dPos=new Vector2D,this.centerPoint=new Vector2D,this.updateHandler=h,this.angle=0,this.parentAngle=0,this.isDel=!1}update(t,e,i){this.centerPoint=e.Add(this.pos.Turn(i)),this.dPos.Copy(this.centerPoint),this.dPos.x-=this.area.width/2,this.dPos.y-=this.area.height/2,this.parentAngle=i,this._updateHandler&&this._updateHandler(t,e,i)}render(t){t.save(),t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),this.sarea?t.drawImage(this.img,this.sarea.x,this.sarea.y,this.sarea.width,this.sarea.height,-this.area.width/2,-this.area.height/2,this.area.width,this.area.height):this.area&&t.drawImage(this.img,-this.area.width/2,-this.area.height/2,this.area.width,this.area.height),t.restore()}set updateHandler(t){t&&(this._updateHandler=t.bind(this))}scale(t){this.area.width=this.barea.width*t,this.area.height=this.barea.height*t}}class $tk_font extends $$tk_base{constructor({text:t="Text Unset",styleType:e="fill",style:i="white",font:s="22px 微软雅黑",angle:h=0,pos:a=[0,0],update:r=null}){super({styleType:e,style:i,pos:a,update:r}),this.font=s,this.angle=h,this.text=t}update(t,e,i){this.centerPoint=e.Add(this.pos.Turn(i)),super.update(t,e,i)}render(t){t.beginPath(),this.__draw(t,!1,()=>{t.font=this.font,t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),t.textAlign="center",t.textBaseline="middle",this.fillStyle&&t.fillText(this.text,0,0),this.strokeStyle&&t.strokeText(this.text,0,0)})}text(t){this.text=t}}class $tk_video extends $tk_sprite{constructor(t){t.img=t.video,super(t),this.video=this.img,this.area.width=this.area.width||this.video.videoWidth,this.area.height=this.area.height||this.video.videoHeight;let e=this.area;this.barea=Object.freeze({width:e.width,height:e.height})}update(t,e,i){super.update(t,e,i),0==this.area.width&&(this.area.width=this.video.videoWidth),0==this.area.height&&(this.area.height=this.video.videoHeight)}pause(t){return!1===t?this.video.play():this.video.paused?this.video.play():this.video.pause()}loop(t){this.video.loop=t}silent(t){this.video.volume=t?1:0}}class $tk_animation extends $tk_sprite{constructor({img:t=null,pos:e=[0,0],area:i={x:0,y:0,width:t.width,height:t.height},sarea:s=null,fps:h=8,frame:a=null,farea:r={width:0,height:0},update:l=null}={}){if(!a||r.height<=0||r.width<=0)return console.warn(`动画配置，帧数设置错误，详情请参看配置：${JSON.stringify([...arguments])}\n            入参说明：area是当前图片的可视区，当多组sprite在同一个图片时，用于限定当前组的范围。若省略则用全图大小作范围。\n            sarea 是最终输出时的裁切区。若省略则输出结果不裁切。 【暂未实现】\n            farea 是帧长宽配置，本方法要求动画组的图片每帧尺寸一样。不可省略。\n            `),null;let n=[],{x:o,y:d}=i;for(let t=0;t<a;t++)n.push({x:o,y:d}),(o+=r.width)>=i.width&&(0,o=i.x,d+=r.height);super({img:t,pos:e,area:r,sarea:{x:n[0].x,y:n[0].y,width:r.width,height:r.height},update:l}),this.fps=Number(h),this.frame=a,this.curFrame=0,this.playTime=0,this.frames=n,this.timeSpan=1e3/this.fps,console.dir(this)}update(t,e,i){this.playTime+=t,this.playTime>=this.timeSpan&&(this.curFrame++,this.curFrame>=this.frame&&(this.curFrame=0),this.sarea.x=this.frames[this.curFrame].x,this.sarea.y=this.frames[this.curFrame].y,this.playTime%=this.timeSpan),super.update(t,e,i),this.parentAngle=i}}
class jGE extends ShowObj{SetConfig(e){this.setting=e,this.run.width=this.setting.width,this.run.height=this.setting.height,this.run.bgColor="black",this.run.status="run"}Init(e){this.add(new EventManager(this)),this.add(new SceneManager(this)),this.add(this.ResManager=new ResManager(this)),this.add(new ObjectFactory(this));const t=this.run,s=this.setting;if(void 0!=e&&this.SetConfig(e),s.dom=document.createElement("canvas"),!s.dom.getContext)return null;s.dom.id=s.id,s.dom.width=s.width,s.dom.height=s.height,this.keyboards=new Set,this.__bind_helper(document.body,["keypress","keydown","keyup"],e=>{this.keyboards.forEach(t=>{t.keyHandle(e)})}),this.__bind_helper(s.dom,["click","mousemove","mousedown","mouseup","touchstart","touchmove","touchend"],e=>{t.curMousePoint=GetEventPosition(e),this.keyboards.forEach(s=>{s.pointHandle(e,t.curMousePoint)})}),t.context2D=s.dom.getContext("2d"),t.debug={profile:!1,showFps:!0,maxTimeSpan:1,fixSpeed:0,showMousePos:!0,showLoadedProcess:!0,msg:[],log:e=>t.debug.msg.push(e)},t.curMousePoint=new Vector2D,t.rendertime=0,t.curfram=0,t.aFps=0,t.vFps=0,t.fps_rc_time=0,this.update(16),this.render()}update(e){const t=this;0==e&&console.log(0);const s=this.run;s.iDBug&&e>s.debug.maxTimeSpan&&(s.debug.maxTimeSpan=e),"run"==s.status&&(s.timemark=new Date,this.managers.forEach(t=>t.update(e)),this.Objects.uObj.forEach((s,i)=>{s.isDel?this.Objects.uObj.splice(i,1):s.update(e,t)}),this.Objects.rObj.map(e=>{e.forEach((t,s)=>{t.isDel&&e.splice(s,1)})}),s.iDBug&&0!=s.debug.fixSpeed?setTimeout(function(){s.fps=Math.round(1e5*(s.rendertime-s.curfram)/17)/100,s.curfram=s.rendertime,t.render()},s.debug.fixSpeed):requestAnimationFrame(function(){s.iDBug&&s.debug.profile&&console.profile("update");let e=new Date-s.timemark;s.fps=Math.round(1e5*(s.rendertime-s.curfram)/e)/100,s.curfram=s.rendertime,s.aFps+=s.fps,s.fps_rc_time++,t.update(e),s.iDBug&&s.debug.profile&&console.profileEnd("update")}))}render(){const e=this.run;if("run"!=e.status)return;if(e.context2D.clearRect(0,0,e.width,e.height),e.context2D.fillStyle=e.bgColor,e.context2D.fillRect(0,0,e.width,e.height),this.Objects.rObj.map(t=>{for(let s of t)s.isDel||s.render(e.context2D)}),e.iDBug){let t=1;e.context2D.font="16px 宋体",e.context2D.fillStyle="white",e.debug.showFps&&(e.context2D.fillText("FPS:"+e.fps,0,16*t++),e.context2D.fillText("aFPS:"+Math.round(e.aFps/e.fps_rc_time*100)/100,0,16*t++)),e.debug.showMousePos&&e.context2D.fillText(`+Pos:(${e.curMousePoint.x},${e.curMousePoint.y})`,0,16*t++),e.debug.showLoadedProcess&&e.context2D.fillText(`Loading:${this.ResManager.GetProcessing()}%`,0,16*t++),e.context2D.fillText(`Ver:${this.version.join(".")}`,0,16*t++),e.debug.msg.forEach(s=>e.context2D.fillText(`mgs:${s}`,0,16*t++))}e.rendertime++;const t=this;e.iDBug&&0!=e.debug.fixSpeed?setTimeout(function(){t.update(17)},e.debug.fixSpeed):requestAnimationFrame(function(){e.iDBug&&e.debug.profile&&console.profile("render"),t.render(),e.iDBug&&e.debug.profile&&console.profileEnd("render")})}_add(e){switch(e.Role){case"Manager":this.managers.add(e);break;case"Keyboard":this.super_add(e.VirtualKeyboard),this.keyboards.add(e);break;default:this.super_add(e)}}clean(){this.Objects.rObj=[],this.Objects.uObj=[]}GetDom(){return this.setting.dom}Pause(){this.run.status="run"==this.run.status?"pause":"run","run"==this.run.status&&(this.update(16),this.render())}GetArea(){return{width:this.setting.dom.width,height:this.setting.dom.height}}GetSetting(){return this.setting}IsInIt(e,t){const s=this.run.context2D;s.save(),t.toPath(s),s.closePath();let i=s.isPointInPath(e.x,e.y);return s.restore(),i}set backgroundColor(e){this.run.bgColor=e}__bind_helper(e,t,s){t.forEach(t=>e.addEventListener(t,s))}_debug_show_me_all(){return console.log("setting:",this.setting,"\n\nrun:",this.run,"\n\ntemp:",this.temp),this.run.context2D}_debug_show_me_obj(){console.log(this.run.Objects.items)}constructor(){super(),this.version=[3,1,4],this.setting={};this.run={};this.temp={},this.managers=new Set,this.super_add=this.add,this.add=this._add;let e={};arguments.length>0&&typeof arguments[0]==typeof{}&&(e=arguments[0]);var t=new GetConfig;for(let s in e)t[s]=e[s];this.SetConfig(t),this.on=(()=>{}),this.one=(()=>{}),this.broadcast=(()=>{}),this.get=(()=>{}),this.run.iDBug=!0,this.Init()}}class Manager{constructor(e,t="默认管理器"){this._jGE=e,e.run.iDBug&&console.log(`[%c报告%c] ${t}已启动。🐠🐠🐠🐠🐠。`,"color:green","color:black"),this.Role="Manager"}update(e){}}
class EventManager extends Manager{constructor(e){super(e,"事件管理器"),this.eventQueue=new Map,this.eventOne=new Map,this.curEventSet=new Set,this.curEventObj=new Map,this._jGE=e,e.on=this.on.bind(this),e.one=this.one.bind(this),e.broadcast=this.broadcast.bind(this)}on(e,t){let n=this.eventQueue.get(e);n||this.eventQueue.set(e,n=[]),n.push(t)}one(e,t){let n=this.eventOne.get(e);n||this.eventOne.set(e,n=[]),n.push(t)}off(e){this.eventQueue.set(e,[])}broadcast(e,t){this.curEventSet.add(e),this.curEventObj.set(e,t)}update(e){let t=new Function;for(let e of this.eventQueue.keys())if(this.curEventSet.has(e)){let n=this.eventQueue.get(e),s=this.curEventObj.get(e);n.forEach(n=>{n(s),t(e,n)})}for(let e of this.eventOne.keys())if(this.curEventSet.has(e)){let n=this.eventOne.get(e),s=this.curEventObj.get(e);n.forEach(n=>{n(s),t(e,n)}),this.eventOne.delete(e)}this.curEventSet.clear(),this.curEventObj.clear()}}
class ObjectFactory extends Manager{constructor(e){super(e,"对象工厂"),this.objectCfg=new Map,this.objectHub=new Map,e.one("jGE.Config.Loaded.object",e=>{let t=new Map([["path",$tk_path],["sprite",$tk_sprite],["text",$tk_font],["video",$tk_video],["anima",$tk_animation]]);e.forEach(e=>{e.setting.forEach(e=>{this.objectCfg.has(e.type)?console.error(`对象配置文件出错，对象类型[${e.type}]发现重复。\n配置:${JSON.stringify(e)}`):(e.pos||(e.pos=[0,0]),this.__init_cfg(e,t),this.objectCfg.set(e.type,e))})})}),e.one("jGE.Resource.Loaded",t=>{this.objectCfg.forEach(t=>t.items.forEach(t=>{"video"==t.type?t.video=e.get(t.res):/^(?:sprite|anima)$/.test(t.type)&&(t.img=e.get(t.res))}))})}__init_cfg(e,t){e.items?e.items.forEach(o=>{if(o.handler=t.get(o.type),!o.handler)return void console.error(`对象配置文件出错：可视部件类型错误${o.type}。\n配置：${JSON.stringify(e)}`);let r={};for(let e in o)if("function"!=typeof o[e])switch(e){case"points":r[e]=[],o[e].forEach(t=>r[e].push(new Vector2D(...t)));break;default:r[e]=o[e]}o.setting=r}):console.error(`对象配置文件出错：items节点缺失。\n配置：${JSON.stringify(e)}`)}create(e){let t=/^@([^@&#].*?)&([^@&#].*?)#([^@&#].*)$/gi.test(e),[o,r,i]=[RegExp.$1,RegExp.$2,RegExp.$3];if(!t){if(!/^@([^@&#].*?)&([^@&#].*)/.test(e))return console.error(`创建对象失败，对象类型配置出错${e}`),null;[o,r]=[RegExp.$1,RegExp.$2],i=r.substr(0,2)+(1e5*Math.random()).toFixed(0)}let s=this.objectCfg.get(r);if(!s||!s.items)return console.error(`创建对象失败，没找到该类配置：${r}；或缺失items字段。`),null;let n=new ShowObj(...s.pos);return s.items.forEach(e=>n.ObjManager.add(new e.handler(e.setting))),this.objectHub.set(`@${o}&${r}#${i}`,n),n}get(e){return this.objectHub.get(e)||this.create(e)}del(e){}update(e,t){}}
class ResManager extends Manager{constructor(e){super(e,"资源管理"),this.LoadingQueue=new Map,this.ResHandler=new Map,this.XHRRes=new Map,this.ResCfg={},this.Init(),this._jGE.get=this.Get.bind(this)}Init(){this.ResHandler.set("default",(e,s)=>e=>{}),this.ResHandler.set("video",this.__get_finish_video),this.ResHandler.set("script",(e,s)=>console.log(e,s)),LoadResources({url:"./res/packages.cfg",type:"config",success:e=>this.LoadCfg(e),error:e=>console.dir(e)})}LoadCfg(e){for(let s in e)e[s].forEach(e=>{this.XHRLoad({url:e.path,type:"config",id:e.path,finish:s=>{e.setting=s}})});this.ResCfg=Object.assign({},e,{status:!1})}LoadRes(e){let s=this.ResCfg.reource;return s&&0!=s.length?(s.forEach(s=>{e&&s.scene!=e||s.setting.forEach(e=>{if(!e.url||!e.type)return;let t=this.ResHandler.get(this.ResHandler.has(e.type)?e.type:"default"),i={id:`@${s.scene}#${e.id}`,type:e.type,url:e.url,success:null};i.finish=t(e,s.scene),this.XHRLoad(i)})}),!0):(console.error("资源配置文件尚未加载，请检查packages.cfg文件reource节点。"),!1)}XHRLoad(e){if(this.XHRRes.has(e.id?e.id:e.url)){console.info("资源加载优化：发现重复加载资源，将调取本地缓存。");let s=this.XHRRes.get(e.url);e.finish(s)}else e.onprogress=((s,t)=>{s=s<t?t:s,this.LoadingQueue.set(e.id,{l:t,t:s})}),e.success=(s=>{this.XHRRes.set(e.id?e.id:e.url,s),e.finish(s)}),LoadResources(e)}GetProcessing(){let[e,s]=[0,0];return this.LoadingQueue.forEach(t=>{e+=t.l,s+=t.t}),s=s||1,Number((e/s*100).toFixed(2))}Abort(){}Get(e){return this.XHRRes.get(e)}update(e,s){let t=Number(this.GetProcessing());if(t<100&&t>0&&console.debug(`资源加载进度：${t}%`),!1===this.ResCfg.status){let e=!0;for(let s of Object.keys(this.ResCfg))"status"!=s&&Array.isArray(this.ResCfg[s])&&!0!==this.ResCfg[s].broadcasted&&(this.ResCfg[s].forEach(s=>{e=e&&void 0!=s.setting}),e&&(this._jGE.broadcast(`jGE.Config.Loaded.${s}`,this.ResCfg[s]),this.ResCfg[s].broadcasted=!0));e&&(this.ResCfg.status=!0,this._jGE.broadcast("jGE.Config.Loaded",this.ResCfg))}}__get_finish_video(e,s){return s=>{e.loop&&(s.loop=!0),Number.isNaN(Number.parseFloat(e.volume))||(s.volume=Number.parseFloat(e.volume))}}}
class SceneManager extends Manager{constructor(t){super(t,"场景调度管理"),t.one("jGE.Config.Loaded.scene",this.InitScene.bind(this)),t.one("jGE.Config.Loaded",this.PlayScene.bind(this)),this.sceneCfg=new Map,this.nextScene="",this.Logo()}InitScene(t){t.forEach(t=>{})}PlayScene(){}Logo(){let t=function(){this.angle=0};console.log("开始Logo展示 🐉 jGE");let e="180px '微软雅黑'",n=130,s=new Vector2D(this._jGE.run.width/2,this._jGE.run.height/2),o=new ShowObj(s.Add({x:180,y:-20}));o.add(new $tk_font({text:"jGE",styleType:"fill",style:"#555555",font:e,pos:[4,4]})),o.add(new $tk_font({text:"jGE",styleType:"fill",style:"#808080",font:e,pos:[3,3]})),o.add(new $tk_font({text:"jGE",styleType:"fill",style:"#aaaaaa",font:e,pos:[2,2]})),o.add(new $tk_font({text:"jGE",styleType:"fill",style:"white",font:e,pos:[0,0]}));let d=new ShowObj(s.Add({x:-180,y:0}));d.add(new $tk_font({text:"🐉",styleType:"fill",style:"rgba(255,0,0,0.82)",font:"200px serif",pos:[0,-10],update:t})),d.add(new $tk_font({text:"🐉",styleType:"stroke",style:"rgba(255,255,255,0.8) 5",font:"200px serif",pos:[0,-10],update:t})),d.add(new $tk_path({styleType:"stroke",style:"#808080 20 round round",points:[[-n,-n],[n,-n],[n,n],[-n,n],-1],pos:[2,2],update:t})),d.add(new $tk_path({styleType:"stroke",style:"rgba(255,255,255,0.9) 20 round round",points:[[-n,-n],[n,-n],[n,n],[-n,n],-1],pos:[0,0],update:t}));{let t=!1,e=this._jGE,n=function(n){void 0==this.showtime&&(this.showtime=0),this.showtime+=n,this.showtime>=1500&&(this.isDel=!0,t||(t=!0,e.broadcast("jGE.Scene.Logo.End")))};o.updateHandler=n,d.updateHandler=n}this._jGE.add(o),this._jGE.add(d)}}
class Keyboard extends Manager{constructor(t){super(t,"虚拟键盘"),this.Role="Keyboard",this.isEnable=!0,this.allkey=new Map,this._virtualkeyboard=new ShowObj;const e=this._virtualkeyboard.AddIn.bind(this._virtualkeyboard),s=this._virtualkeyboard.Copy.bind(this._virtualkeyboard);this._virtualkeyboard.AddIn=((...t)=>{e(...t),this.flash()}),this._virtualkeyboard.Copy=((...t)=>{s(...t),this.flash()})}keyHandle(t){this.isEnable&&this.allkey.has(t.code)&&this.allkey.get(t.code).on(t)}pointHandle(t,e){if(!this.isEnable)return;let s={x:e.x,y:e.y,style:"point"};switch(this._jGE.run.debug.log(t.type),t.type){case"mousemove":s.type="over";break;case"mousedown":s.type="keydown";break;case"mouseup":s.type="keyup";break;case"click":s.type="keypress";break;case"dblclick":s.type="dblclick";break;case"touchstart":s.type="keydown";break;case"touchmove":s.type="over";break;case"touchend":s.type="keyup"}this.allkey.forEach(t=>t.on(s))}turnOn(){this.isEnable=!0}turnOff(){this.isEnable=!1}add(t){t._jGE=this._jGE,this.allkey.set(t.code,t),this.VirtualKeyboard.add(t)}get(t){return this.allkey.get(t)}get VirtualKeyboard(){return this._virtualkeyboard}flash(){this.allkey.forEach(t=>t.flash()),this.VirtualKeyboard.update(0,this._jGE),this.allkey.forEach(t=>t.reset())}}class Key extends ShowObj{constructor({key:t="",code:e="",handler:s=null,upObjs:a=[],downObjs:h=[],hoverObj:i=[],actObj:r=null,x:o=0,y:l=0,angle:n=0}={}){super({x:o,y:l,angle:n}),this.handler=new Map,this.code=e,this.KEYSTATUS={Normal:Symbol(),Down:Symbol(),Hover:Symbol()},this.status=this.KEYSTATUS.Down,this.btShowObjs=new Map([[this.KEYSTATUS.Normal,a],[this.KEYSTATUS.Down,h],[this.KEYSTATUS.Hover,i]]),this.activeArea=r||a[0],this._jGE=null,null!==s&&addEventListener(type,s),this._changeStatus("keyup")}on(t){if("point"==t.style){if(!this._IsHit(t)){if(this.status!=this.KEYSTATUS.Hover)return;t.type="out"}t.code=this.code}if(this._changeStatus(t.type,t.style),!this.handler.has(t.type))return!1;this.handler.get(t.type).forEach(e=>{e(t)})}addEventListener(t,e){this.handler.has(t)||this.handler.set(t,new Set),this.handler.get(t).add(e)}removeEventListener(t){this.handler.has(t)&&this.handler.get(t).clear()}_changeStatus(t,e){if("keypress"==t)return;let s=this.status;switch(t){case"keydown":this.status=this.KEYSTATUS.Down;break;case"keyup":this.status="point"==e?this.KEYSTATUS.Hover:this.KEYSTATUS.Normal;break;case"over":this.status=this.KEYSTATUS.Hover;break;case"out":this.status=this.KEYSTATUS.Normal}s!=this.status&&(this.btShowObjs.get(s).forEach(t=>{this.del(t)}),this.btShowObjs.get(this.status).forEach(t=>{this.add(t)}))}flash(){this.btShowObjs.forEach(t=>t.forEach(t=>this.add(t)))}reset(){this.btShowObjs.forEach((t,e)=>{e!=this.status&&t.forEach(t=>this.del(t))})}_IsHit(t){return this._jGE.IsInIt(t,this.activeArea)}}
"use strict";function GetConfig(){return{id:"jGE_"+100*Math.random(),dom:null,width:700,height:750,fps:30,isRoundWorld:!0,keyHandler:function(n){}}}