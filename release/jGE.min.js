function RandomClamped(){let t=Math.floor(100*Math.random())%2,e=Math.random();return(1==t?-1:1)*e}function GetEventPosition(t){var e,s;if(-1!=t.type.indexOf("touch"))try{var i=t.changedTouches[0];s=Math.floor(i.pageY),e=Math.floor(i.pageX)}catch(e){console.error(t,e)}else t.offsetX||0==t.offsetX?(e=t.offsetX,s=t.offsetY):console.error("获取鼠标坐标失败！");return new Vector2D(e,s)}function LoadResources({method:t="POST",async:e=!0,data:s=null,type:i="json",url:r="",success:n=(t=>{}),error:h=(t=>{}),ontimeout:o=(t=>{}),onprogress:a=(t=>{}),onuprogress:l=(t=>{})}){let d=i;"image"==i||"video"==i?(t="GET",i="blob"):"config"==i?(t="GET",i="json"):(i="script")&&(t="GET",i="text");let u=new XMLHttpRequest;u.open(t,r,e),e&&(u.responseType=i),u.setRequestHeader("Content-type","application/x-www-four-urlencoded;charset=UTF-8"),u.onload=function(t){if(200==this.status||304==this.status){let t=this.response;if(e||"json"!=i){if("image"==d)(t=new Image).src=window.URL.createObjectURL(this.response),t.onload=(e=>window.URL.revokeObjectURL(t.src));else if("video"==d)(t=document.createElement("video")).src=window.URL.createObjectURL(this.response),t.onload=(e=>window.URL.revokeObjectURL(t.src));else if("script"==d){let e=document.createElement("script");e.textContent=t,document.body.appendChild(e)}}else t=JSON.parse(t);n.call(this,t)}},u.ontimeout=o,u.onerror=h,u.upload.onprogress=l,u.onprogress=function(t){a.call(this,t.total,t.loaded)};try{u.send(s)}catch(t){h.call(this,t)}}function GetURL({method:t="POST",async:e=!0,data:s=null,type:i="json",url:r="",ontimeout:n=(t=>{}),onprogress:h=(t=>{}),onuprogress:o=(t=>{})}){return new Promise((a,l)=>{let d,u=i;switch(i){case"image":case"video":d="blob",t="GET";break;case"config":d="json",t="GET";break;case"script":d="text",t="GET";break;default:d=i}let c=new XMLHttpRequest;c.open(t,r,e),e&&(c.responseType=d),c.setRequestHeader("Content-type","application/x-www-four-urlencoded;charset=UTF-8"),c.onload=function(t){if(404==this.status)return l(this);if(200==this.status||304==this.status){let t=this.response;if(e||"json"!=i){if("image"==u)(t=new Image).src=window.URL.createObjectURL(this.response),t.onload=(e=>window.URL.revokeObjectURL(t.src));else if("video"==u)(t=document.createElement("video")).src=window.URL.createObjectURL(this.response),t.onload=(e=>window.URL.revokeObjectURL(t.src));else if("script"==u){let e=document.createElement("script");e.textContent=t,document.body.appendChild(e)}}else t=JSON.parse(t);a(t)}},c.ontimeout=n,c.onerror=l,c.upload.onprogress=o,c.onprogress=(t=>h.call(this,t.total,t.loaded)),c.send(s)})}function GetConfig(){return{id:"jGE_"+100*Math.random(),dom:null,width:700,height:750,fps:30,isRoundWorld:!0,keyHandler:function(t){}}}const π=Math.PI,π2=2*π,π_hf=.5*π;class Vector2D{constructor(...t){let e,s;1==t.length?({x:e=0,y:s=0}=t[0]):[e=0,s=0]=t,this.x=e,this.y=s}Copy(t){this.x=t.x,this.y=t.y}Cloen(){return new Vector2D(this)}Zero(){}isZero(){return 0===this.x&&0===this.y}Length(){return Math.sqrt(this.x*this.x+this.y*this.y)}LengthSq(){return this.x*this.x+this.y*this.y}Normalize(){var t=this.Length();return new Vector2D(this.x/t,this.y/t)}Dot(t){return this.x*t.x+this.y*t.y}Sign(t){}Perp(){}Truncate(t){}Distance(t){return Math.sqrt(this.DistanceSq(t))}DistanceSq(t){}GetReverse(){}AddIn(t){this.x+=t.x,this.y+=t.y}MinusIn(t){this.x-=t.x,this.y-=t.y}MultiplyIn(t){this.x*=t,this.y*=t}Add(t){return new Vector2D(this.x+t.x,this.y+t.y)}Minus(t){return new Vector2D(this.x-t.x,this.y-t.y)}Multiply(t){return new Vector2D(this.x*t,this.y*t)}Turn(t){return new Vector2D(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}Equal(t){return this.x==t.x&&this.y==t.y}*[Symbol.iterator](){yield this.x,yield this.y}}class ShowObj extends Vector2D{constructor({x:t=0,y:e=0,angle:s=0}={}){super({x:t,y:e});let i=Symbol("ObjManager"),r=this.Objects={rObj:[],uObj:[],items:new WeakSet};this.isDel=!1,this.angle=s,this.visible=!0,this[i]={add:function(t){r.items.has(t)||(t.isDel=!1,r.items.add(t),r.uObj.push(t),void 0!=t.render&&(void 0==t.index&&(t.index=1),Array.isArray(r.rObj[t.index])||(r.rObj[t.index]=[]),r.rObj[t.index].push(t)))},del:function(t){r.items.has(t)&&(t.isDel=!0,r.items.delete(t))}},this.add=((...t)=>(this[i].add.bind(this)(...t),this)),this.del=this[i].del.bind(this)}update(t,e={x:0,y:0},s=0){this.visible&&(this.Objects.uObj.forEach((i,r)=>{i.isDel?this.Objects.uObj.splice(r,1):i.update(t,new Vector2D(this).Add(e),this.angle+s)}),this._updateHandler&&this._updateHandler(t,new Vector2D(this),this.angle),this.Objects.rObj.map(t=>{t.forEach((e,s)=>{e.isDel&&t.splice(s,1)})}))}render(t){this.visible&&this.Objects.rObj.map(e=>{for(let s of e)s.isDel||s.render(t)})}*[Symbol.iterator](){for(let t=0;t<this.Objects.uObj.length;t++)yield this.Objects.uObj[t]}set updateHandler(t){t&&(this._updateHandler=t.bind(this))}}class $$tk_base{constructor({styleType:t=null,style:e=null,pos:s=new Vector2D,update:i=null}={}){this.fillStyle=null,this.strokeStyle=null,this.isAutoEnd=!1,this.angle=0,this.parentAngle=0,this.styleType=t,this.setStyle(e),this.pos=new Vector2D(...s),this.centerPoint=new Vector2D,this.updateHandler=i,this.isDel=!1}update(t,e,s){this._updateHandler&&this._updateHandler(t,e,s),this.parentAngle=s}render(t){}setStyle(t){let e="",s="";switch(this.styleType){case"fill":this.fillStyle=t;break;case"stroke":e=t;break;case"both":({fillStyle:s,strokeStylest:e}=t)}if(e){let[t,i=1,r="bull",n="miter"]=e.split(" ");this.strokeStyle=t,this.lineWidth=i,this.lineCap=r,this.lineJoin=n,this.fillStyle=s}}__draw(t,e,s){t.save(),e&&e(t),this.fillStyle&&(t.fillStyle=this.fillStyle,t.fill()),this.strokeStyle&&(t.strokeStyle=this.strokeStyle,t.lineWidth=1*this.lineWidth,t.lineCap=this.lineCap,t.lineJoin=this.lineJoin,this.isAutoEnd&&t.closePath(),t.stroke()),s&&s(t),t.restore()}set updateHandler(t){t&&(this._updateHandler=t.bind(this))}}class $tk_path extends $$tk_base{constructor({styleType:t="stroke",style:e="white",points:s=null,pos:i=[0,0],update:r=null}={}){if(!s||s.length<=0)return null;super({styleType:t,style:e,pos:i,update:r}),this.points=[];let n=null;this.isAutoEnd=-1==s[s.length-1]&&(n=s.pop(),!0),s.forEach(t=>{this.points.push(Array.isArray(t)?new Vector2D(t[0],t[1]):t)}),n&&s.push(n),this.setting={styleType:t,style:e,points:s,pos:i,update:r}}update(t,e,s){this.centerPoint=e.Add(this.pos.Turn(s)),super.update(t,e,s)}render(t){0==this.points.length||this.isDel||this.__draw(t,()=>this.toPath(t),!1)}toPath(t){t.beginPath(),t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),t.moveTo(this.points[0].x,this.points[0].y);for(let e of this.points)t.lineTo(e.x,e.y)}clone(){return new $tk_path(this.setting)}}class $tk_ellipse extends $$tk_base{constructor({styleType:t="stroke",style:e="white 1",points:s=null,pos:i=[0,0],update:r=null,a:n=0,b:h=0,r:o=0}={}){super({styleType:t,style:e,pos:i}),0!=o&&(n=o,h=o),this.a=n,this.b=h,this.r=Math.max(n,h),this.ratioX=n/this.r,this.ratioY=h/this.r,this.isAutoEnd=!0}update(t,e,s){this.centerPoint=e.Add(this.pos.Turn(s)),super.update(t,e,s)}render(t){this.__draw(t,()=>this.toPath(t),!1)}toPath(t){t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),this.a!=this.b&&t.scale(this.ratioX,this.ratioY),t.beginPath(),t.arc(this.pos.x/this.ratioX,this.pos.y/this.ratioY,this.r,0,2*π,!1)}}class $tk_arc extends $$tk_base{constructor(){super({styleType:styleType,style:style,pos:pos})}}class $tk_sprite{constructor({img:t={},pos:e=[0,0],area:s={width:t.width,height:t.height},sarea:i=null,update:r=null}={}){if(null==t)return null;this.img=t,this.barea=Object.freeze({width:s.width,height:s.height}),this.area=s,this.sarea=i,this.pos=new Vector2D(...e),this.dPos=new Vector2D,this.centerPoint=new Vector2D,this.updateHandler=r,this.angle=0,this.parentAngle=0,this.isDel=!1}update(t,e,s){this.centerPoint=e.Add(this.pos.Turn(s)),this.dPos.Copy(this.centerPoint),this.dPos.x-=this.area.width/2,this.dPos.y-=this.area.height/2,this.parentAngle=s,this._updateHandler&&this._updateHandler(t,e,s)}render(t){t.save(),t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),this.sarea?t.drawImage(this.img,this.sarea.x,this.sarea.y,this.sarea.width,this.sarea.height,-this.area.width/2,-this.area.height/2,this.area.width,this.area.height):this.area&&t.drawImage(this.img,-this.area.width/2,-this.area.height/2,this.area.width,this.area.height),t.restore()}set updateHandler(t){t&&(this._updateHandler=t.bind(this))}scale(t){this.area.width=this.barea.width*t,this.area.height=this.barea.height*t}}class $tk_font extends $$tk_base{constructor({text:t="Text Unset",styleType:e="fill",style:s="white",font:i="22px 微软雅黑",angle:r=0,pos:n=[0,0],update:h=null}){super({styleType:e,style:s,pos:n,update:h}),this.font=i,this.angle=r,this.text=t}update(t,e,s){this.centerPoint=e.Add(this.pos.Turn(s)),super.update(t,e,s)}render(t){t.beginPath(),this.__draw(t,!1,()=>{t.font=this.font,t.translate(this.centerPoint.x,this.centerPoint.y),t.rotate(this.angle+this.parentAngle),t.textAlign="center",t.textBaseline="middle",this.fillStyle&&t.fillText(this.text,0,0),this.strokeStyle&&t.strokeText(this.text,0,0)})}text(t){this.text=t}}class $tk_video extends $tk_sprite{constructor(t){t.img=t.video,super(t),this.video=this.img,this.area.width=this.area.width||this.video.videoWidth,this.area.height=this.area.height||this.video.videoHeight;let e=this.area;this.barea=Object.freeze({width:e.width,height:e.height})}update(t,e,s){super.update(t,e,s),0==this.area.width&&(this.area.width=this.video.videoWidth),0==this.area.height&&(this.area.height=this.video.videoHeight)}pause(t){return!1===t?this.video.play():this.video.paused?this.video.play():this.video.pause()}loop(t){this.video.loop=t}silent(t){this.video.volume=t?1:0}}class $tk_animation extends $tk_sprite{constructor({img:t=null,pos:e=[0,0],area:s={x:0,y:0,width:t.width,height:t.height},sarea:i=null,fps:r=8,frame:n=null,farea:h={width:0,height:0},update:o=null}={}){if(!n||h.height<=0||h.width<=0)return console.warn(`动画配置，帧数设置错误，详情请参看配置：${JSON.stringify([...arguments])}\n            入参说明：area是当前图片的可视区，当多组sprite在同一个图片时，用于限定当前组的范围。若省略则用全图大小作范围。\n            sarea 是最终输出时的裁切区。若省略则输出结果不裁切。 【暂未实现】\n            farea 是帧长宽配置，本方法要求动画组的图片每帧尺寸一样。不可省略。\n            `),null;let a=[],{x:l,y:d}=s;for(let t=0;t<n;t++)a.push({x:l,y:d}),(l+=h.width)>=s.width&&(0,l=s.x,d+=h.height);super({img:t,pos:e,area:h,sarea:{x:a[0].x,y:a[0].y,width:h.width,height:h.height},update:o}),this.fps=Number(r),this.frame=n,this.curFrame=0,this.playTime=0,this.frames=a,this.timeSpan=1e3/this.fps,console.dir(this)}update(t,e,s){this.playTime+=t,this.playTime>=this.timeSpan&&(this.curFrame++,this.curFrame>=this.frame&&(this.curFrame=0),this.sarea.x=this.frames[this.curFrame].x,this.sarea.y=this.frames[this.curFrame].y,this.playTime%=this.timeSpan),super.update(t,e,s),this.parentAngle=s}}class jGE extends ShowObj{SetConfig(t){this.setting=t,this.run.width=this.setting.width,this.run.height=this.setting.height,this.run.bgColor="black",this.run.status="run"}Init(t){this.add(new EventManager(this)),this.add(new SceneManager(this)),this.add(this.ResManager=new ResManager(this)),this.add(new ObjectFactory(this));const e=this.run,s=this.setting;if(void 0!=t&&this.SetConfig(t),s.dom=document.createElement("canvas"),!s.dom.getContext)return null;s.dom.id=s.id,s.dom.width=s.width,s.dom.height=s.height,this.keyboards=new Set,this.__bind_helper(document.body,["keypress","keydown","keyup"],t=>{this.keyboards.forEach(e=>{e.keyHandle(t)})}),this.__bind_helper(s.dom,["click","mousemove","mousedown","mouseup","touchstart","touchmove","touchend"],t=>{e.curMousePoint=GetEventPosition(t),this.keyboards.forEach(s=>{s.pointHandle(t,e.curMousePoint)})}),e.context2D=s.dom.getContext("2d"),e.debug={profile:!1,showFps:!0,maxTimeSpan:1,fixSpeed:0,showMousePos:!0,showLoadedProcess:!0,msg:[],log:t=>e.debug.msg.push(t)},e.curMousePoint=new Vector2D,e.rendertime=0,e.curfram=0,e.aFps=0,e.vFps=0,e.fps_rc_time=0,this.update(16),this.render()}update(t){const e=this;0==t&&console.log(0);const s=this.run;s.iDBug&&t>s.debug.maxTimeSpan&&(s.debug.maxTimeSpan=t),"run"==s.status&&(s.timemark=new Date,this.managers.forEach(e=>e.update(t)),this.Objects.uObj.forEach((s,i)=>{s.isDel?this.Objects.uObj.splice(i,1):s.update(t,e)}),this.Objects.rObj.map(t=>{t.forEach((e,s)=>{e.isDel&&t.splice(s,1)})}),s.iDBug&&0!=s.debug.fixSpeed?setTimeout(function(){s.fps=Math.round(1e5*(s.rendertime-s.curfram)/17)/100,s.curfram=s.rendertime,e.render()},s.debug.fixSpeed):requestAnimationFrame(function(){s.iDBug&&s.debug.profile&&console.profile("update");let t=new Date-s.timemark;s.fps=Math.round(1e5*(s.rendertime-s.curfram)/t)/100,s.curfram=s.rendertime,s.aFps+=s.fps,s.fps_rc_time++,e.update(t),s.iDBug&&s.debug.profile&&console.profileEnd("update")}))}render(){const t=this.run;if("run"!=t.status)return;if(t.context2D.clearRect(0,0,t.width,t.height),t.context2D.fillStyle=t.bgColor,t.context2D.fillRect(0,0,t.width,t.height),this.Objects.rObj.map(e=>{for(let s of e)s.isDel||s.render(t.context2D)}),t.iDBug){let e=1;t.context2D.font="16px 宋体",t.context2D.fillStyle="white",t.debug.showFps&&(t.context2D.fillText("FPS:"+t.fps,0,16*e++),t.context2D.fillText("aFPS:"+Math.round(t.aFps/t.fps_rc_time*100)/100,0,16*e++)),t.debug.showMousePos&&t.context2D.fillText(`+Pos:(${t.curMousePoint.x},${t.curMousePoint.y})`,0,16*e++),t.debug.showLoadedProcess&&t.context2D.fillText(`Loading:${this.ResManager.GetProcessing()}%`,0,16*e++),t.context2D.fillText(`Ver:${this.version.join(".")}`,0,16*e++),t.debug.msg.forEach(s=>t.context2D.fillText(`mgs:${s}`,0,16*e++))}t.rendertime++;const e=this;t.iDBug&&0!=t.debug.fixSpeed?setTimeout(function(){e.update(17)},t.debug.fixSpeed):requestAnimationFrame(function(){t.iDBug&&t.debug.profile&&console.profile("render"),e.render(),t.iDBug&&t.debug.profile&&console.profileEnd("render")})}_add(t){switch(t.Role){case"Manager":this.managers.add(t);break;case"Keyboard":this.super_add(t.VirtualKeyboard),this.keyboards.add(t);break;default:this.super_add(t)}}clean(){this.Objects.rObj=[],this.Objects.uObj=[]}GetDom(){return this.setting.dom}Pause(){this.run.status="run"==this.run.status?"pause":"run","run"==this.run.status&&(this.update(16),this.render())}GetArea(){return{width:this.setting.dom.width,height:this.setting.dom.height}}GetSetting(){return this.setting}IsInIt(t,e){const s=this.run.context2D;s.save(),e.toPath(s),s.closePath();let i=s.isPointInPath(t.x,t.y);return s.restore(),i}set backgroundColor(t){this.run.bgColor=t}__bind_helper(t,e,s){e.forEach(e=>t.addEventListener(e,s))}_debug_show_me_all(){return console.log("setting:",this.setting,"\n\nrun:",this.run,"\n\ntemp:",this.temp),this.run.context2D}_debug_show_me_obj(){console.log(this.run.Objects.items)}constructor(){super(),this.version=[3,1,4],this.setting={};this.run={};this.temp={},this.managers=new Set,this.super_add=this.add,this.add=this._add;let t={};arguments.length>0&&typeof arguments[0]==typeof{}&&(t=arguments[0]);var e=new GetConfig;for(let s in t)e[s]=t[s];this.SetConfig(e),this.on=(()=>{}),this.one=(()=>{}),this.broadcast=(()=>{}),this.get=(()=>{}),this.run.iDBug=!0,this.Init()}}class Manager{constructor(t,e="默认管理器"){this._jGE=t,t.run.iDBug&&console.log(`[%c报告%c] ${e}已启动。🐠🐠🐠🐠🐠。`,"color:green","color:black"),this.Role="Manager"}update(t){}}class EventManager extends Manager{constructor(t){super(t,"事件管理器"),this.eventQueue=new Map,this.eventOne=new Map,this.curEventSet=new Set,this.curEventObj=new Map,this._jGE=t,t.on=this.on.bind(this),t.one=this.one.bind(this),t.broadcast=this.broadcast.bind(this)}on(t,e){let s=this.eventQueue.get(t);s||this.eventQueue.set(t,s=[]),s.push(e)}one(t,e){let s=this.eventOne.get(t);s||this.eventOne.set(t,s=[]),s.push(e)}off(t){this.eventQueue.set(t,[])}broadcast(t,e){this.curEventSet.add(t),this.curEventObj.set(t,e)}update(t){let e=new Function;for(let t of this.eventQueue.keys())if(this.curEventSet.has(t)){let s=this.eventQueue.get(t),i=this.curEventObj.get(t);s.forEach(s=>{s(i),e(t,s)})}for(let t of this.eventOne.keys())if(this.curEventSet.has(t)){let s=this.eventOne.get(t),i=this.curEventObj.get(t);s.forEach(s=>{s(i),e(t,s)}),this.eventOne.delete(t)}this.curEventSet.clear(),this.curEventObj.clear()}}class ObjectFactory extends Manager{constructor(t){super(t,"对象工厂"),this.objectCfg=new Map,this.objectHub=new Map,t.one("jGE.Config.Loaded.object",t=>{let e=new Map([["path",$tk_path],["sprite",$tk_sprite],["text",$tk_font],["video",$tk_video],["anima",$tk_animation]]);t.forEach(t=>{t.setting.forEach(t=>{this.objectCfg.has(t.type)?console.error(`对象配置文件出错，对象类型[${t.type}]发现重复。\n配置:${JSON.stringify(t)}`):(t.pos||(t.pos=[0,0]),this.__init_cfg(t,e),this.objectCfg.set(t.type,t))})})}),t.one("jGE.Resource.Loaded",e=>{this.objectCfg.forEach(e=>e.items.forEach(e=>{"video"==e.type?e.video=t.get(e.res):/^(?:sprite|anima)$/.test(e.type)&&(e.img=t.get(e.res))}))})}__init_cfg(t,e){t.items?t.items.forEach(s=>{if(s.handler=e.get(s.type),!s.handler)return void console.error(`对象配置文件出错：可视部件类型错误${s.type}。\n配置：${JSON.stringify(t)}`);let i={};for(let t in s)if("function"!=typeof s[t])switch(t){case"points":i[t]=[],s[t].forEach(e=>i[t].push(new Vector2D(...e)));break;default:i[t]=s[t]}s.setting=i}):console.error(`对象配置文件出错：items节点缺失。\n配置：${JSON.stringify(t)}`)}create(t){let e=/^@([^@&#].*?)&([^@&#].*?)#([^@&#].*)$/gi.test(t),[s,i,r]=[RegExp.$1,RegExp.$2,RegExp.$3];if(!e){if(!/^@([^@&#].*?)&([^@&#].*)/.test(t))return console.error(`创建对象失败，对象类型配置出错${t}`),null;[s,i]=[RegExp.$1,RegExp.$2],r=i.substr(0,2)+(1e5*Math.random()).toFixed(0)}let n=this.objectCfg.get(i);if(!n||!n.items)return console.error(`创建对象失败，没找到该类配置：${i}；或缺失items字段。`),null;let h=new ShowObj(...n.pos);return n.items.forEach(t=>h.ObjManager.add(new t.handler(t.setting))),this.objectHub.set(`@${s}&${i}#${r}`,h),h}get(t){return this.objectHub.get(t)||this.create(t)}del(t){}update(t,e){}}class ResManager extends Manager{constructor(t){super(t,"资源管理"),this.LoadingQueue=new Map,this.ResHandler=new Map,this.XHRRes=new Map,this.ResCfg={},this.Init(),this._jGE.get=this.Get.bind(this)}Init(){this.ResHandler.set("default",(t,e)=>t=>{}),this.ResHandler.set("video",this.__get_finish_video),this.ResHandler.set("script",(t,e)=>console.log(t,e)),LoadResources({url:"./res/packages.cfg",type:"config",success:t=>this.LoadCfg(t),error:t=>console.dir(t)})}LoadCfg(t){for(let e in t)t[e].forEach(t=>{this.XHRLoad({url:t.path,type:"config",id:t.path,finish:e=>{t.setting=e}})});this.ResCfg=Object.assign({},t,{status:!1})}LoadRes(t){let e=this.ResCfg.reource;return e&&0!=e.length?(e.forEach(e=>{t&&e.scene!=t||e.setting.forEach(t=>{if(!t.url||!t.type)return;let s=this.ResHandler.get(this.ResHandler.has(t.type)?t.type:"default"),i={id:`@${e.scene}#${t.id}`,type:t.type,url:t.url,success:null};i.finish=s(t,e.scene),this.XHRLoad(i)})}),!0):(console.error("资源配置文件尚未加载，请检查packages.cfg文件reource节点。"),!1)}XHRLoad(t){if(this.XHRRes.has(t.id?t.id:t.url)){console.info("资源加载优化：发现重复加载资源，将调取本地缓存。");let e=this.XHRRes.get(t.url);t.finish(e)}else t.onprogress=((e,s)=>{e=e<s?s:e,this.LoadingQueue.set(t.id,{l:s,t:e})}),t.success=(e=>{this.XHRRes.set(t.id?t.id:t.url,e),t.finish(e)}),LoadResources(t)}GetProcessing(){let[t,e]=[0,0];return this.LoadingQueue.forEach(s=>{t+=s.l,e+=s.t}),e=e||1,Number((t/e*100).toFixed(2))}Abort(){}Get(t){return this.XHRRes.get(t)}update(t,e){let s=Number(this.GetProcessing());if(s<100&&s>0&&console.debug(`资源加载进度：${s}%`),!1===this.ResCfg.status){let t=!0;for(let e of Object.keys(this.ResCfg))"status"!=e&&Array.isArray(this.ResCfg[e])&&!0!==this.ResCfg[e].broadcasted&&(this.ResCfg[e].forEach(e=>{t=t&&void 0!=e.setting}),t&&(this._jGE.broadcast(`jGE.Config.Loaded.${e}`,this.ResCfg[e]),this.ResCfg[e].broadcasted=!0));t&&(this.ResCfg.status=!0,this._jGE.broadcast("jGE.Config.Loaded",this.ResCfg))}}__get_finish_video(t,e){return e=>{t.loop&&(e.loop=!0),Number.isNaN(Number.parseFloat(t.volume))||(e.volume=Number.parseFloat(t.volume))}}}class SceneManager extends Manager{constructor(t){super(t,"场景调度管理"),t.one("jGE.Config.Loaded.scene",this.InitScene.bind(this)),t.one("jGE.Config.Loaded",this.PlayScene.bind(this)),this.sceneCfg=new Map,this.nextScene="",this.Logo()}InitScene(t){t.forEach(t=>{})}PlayScene(){}Logo(){let t=function(){this.angle=0};console.log("开始Logo展示 🐉 jGE");let e="180px '微软雅黑'",s=130,i=new Vector2D(this._jGE.run.width/2,this._jGE.run.height/2),r=new ShowObj(i.Add({x:180,y:-20}));r.add(new $tk_font({text:"jGE",styleType:"fill",style:"#555555",font:e,pos:[4,4]})),r.add(new $tk_font({text:"jGE",styleType:"fill",style:"#808080",font:e,pos:[3,3]})),r.add(new $tk_font({text:"jGE",styleType:"fill",style:"#aaaaaa",font:e,pos:[2,2]})),r.add(new $tk_font({text:"jGE",styleType:"fill",style:"white",font:e,pos:[0,0]}));let n=new ShowObj(i.Add({x:-180,y:0}));n.add(new $tk_font({text:"🐉",styleType:"fill",style:"rgba(255,0,0,0.82)",font:"200px serif",pos:[0,-10],update:t})),n.add(new $tk_font({text:"🐉",styleType:"stroke",style:"rgba(255,255,255,0.8) 5",font:"200px serif",pos:[0,-10],update:t})),n.add(new $tk_path({styleType:"stroke",style:"#808080 20 round round",points:[[-s,-s],[s,-s],[s,s],[-s,s],-1],pos:[2,2],update:t})),n.add(new $tk_path({styleType:"stroke",style:"rgba(255,255,255,0.9) 20 round round",points:[[-s,-s],[s,-s],[s,s],[-s,s],-1],pos:[0,0],update:t}));{let t=!1,e=this._jGE,s=function(s){void 0==this.showtime&&(this.showtime=0),this.showtime+=s,this.showtime>=1500&&(this.isDel=!0,t||(t=!0,e.broadcast("jGE.Scene.Logo.End")))};r.updateHandler=s,n.updateHandler=s}this._jGE.add(r),this._jGE.add(n)}}class Keyboard extends Manager{constructor(t){super(t,"虚拟键盘"),this.Role="Keyboard",this.isEnable=!0,this.allkey=new Map,this._virtualkeyboard=new ShowObj;const e=this._virtualkeyboard.AddIn.bind(this._virtualkeyboard),s=this._virtualkeyboard.Copy.bind(this._virtualkeyboard);this._virtualkeyboard.AddIn=((...t)=>{e(...t),this.flash()}),this._virtualkeyboard.Copy=((...t)=>{s(...t),this.flash()})}keyHandle(t){this.isEnable&&this.allkey.has(t.code)&&this.allkey.get(t.code).on(t)}pointHandle(t,e){if(!this.isEnable)return;let s={x:e.x,y:e.y,style:"point"};switch(this._jGE.run.debug.log(t.type),t.type){case"mousemove":s.type="over";break;case"mousedown":s.type="keydown";break;case"mouseup":s.type="keyup";break;case"click":s.type="keypress";break;case"dblclick":s.type="dblclick";break;case"touchstart":s.type="keydown";break;case"touchmove":s.type="over";break;case"touchend":s.type="keyup"}this.allkey.forEach(t=>t.on(s))}turnOn(){this.isEnable=!0}turnOff(){this.isEnable=!1}add(t){t._jGE=this._jGE,this.allkey.set(t.code,t),this.VirtualKeyboard.add(t)}get(t){return this.allkey.get(t)}get VirtualKeyboard(){return this._virtualkeyboard}flash(){this.allkey.forEach(t=>t.flash()),this.VirtualKeyboard.update(0,this._jGE),this.allkey.forEach(t=>t.reset())}}class Key extends ShowObj{constructor({key:t="",code:e="",handler:s=null,upObjs:i=[],downObjs:r=[],hoverObj:n=[],actObj:h=null,x:o=0,y:a=0,angle:l=0}={}){super({x:o,y:a,angle:l}),this.handler=new Map,this.code=e,this.KEYSTATUS={Normal:Symbol(),Down:Symbol(),Hover:Symbol()},this.status=this.KEYSTATUS.Down,this.btShowObjs=new Map([[this.KEYSTATUS.Normal,i],[this.KEYSTATUS.Down,r],[this.KEYSTATUS.Hover,n]]),this.activeArea=h||i[0],this._jGE=null,null!==s&&addEventListener(type,s),this._changeStatus("keyup")}on(t){if("point"==t.style){if(!this._IsHit(t)){if(this.status!=this.KEYSTATUS.Hover)return;t.type="out"}t.code=this.code}if(this._changeStatus(t.type,t.style),!this.handler.has(t.type))return!1;this.handler.get(t.type).forEach(e=>{e(t)})}addEventListener(t,e){this.handler.has(t)||this.handler.set(t,new Set),this.handler.get(t).add(e)}removeEventListener(t){this.handler.has(t)&&this.handler.get(t).clear()}_changeStatus(t,e){if("keypress"==t)return;let s=this.status;switch(t){case"keydown":this.status=this.KEYSTATUS.Down;break;case"keyup":this.status="point"==e?this.KEYSTATUS.Hover:this.KEYSTATUS.Normal;break;case"over":this.status=this.KEYSTATUS.Hover;break;case"out":this.status=this.KEYSTATUS.Normal}s!=this.status&&(this.btShowObjs.get(s).forEach(t=>{this.del(t)}),this.btShowObjs.get(this.status).forEach(t=>{this.add(t)}))}flash(){this.btShowObjs.forEach(t=>t.forEach(t=>this.add(t)))}reset(){this.btShowObjs.forEach((t,e)=>{e!=this.status&&t.forEach(t=>this.del(t))})}_IsHit(t){return this._jGE.IsInIt(t,this.activeArea)}}